generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Class {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  date        DateTime
  time        String
  capacity    Int
  enrolled    Int      @default(0)
  createdById String
  users       String[] @default([])
  sedeId      Int
  sede        Sede     @relation(fields: [sedeId], references: [id])
  goals       Goal[]
}

model MuscleGroup {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  exercises Exercise[]
}

model Exercise {
  id            Int         @id @default(autoincrement())
  name          String
  equipment     String?
  videoUrl      String?
  muscleGroupId Int
  muscleGroup   MuscleGroup @relation(fields: [muscleGroupId], references: [id])

  routines     RoutineExercise[]
  performances ExercisePerformance[]
}

model Routine {
  id           Int                   @id @default(autoincrement())
  name         String
  description  String?
  level        Level                 @default(Beginner)
  duration     Int?
  icon         String?
  exercises    RoutineExercise[]
  users        String[]              @default([])
  sedeId       Int
  sede         Sede                  @relation(fields: [sedeId], references: [id])
  goals        Goal[]
  performances ExercisePerformance[]
}

model RoutineExercise {
  id         Int  @id @default(autoincrement())
  routineId  Int
  exerciseId Int
  sets       Int?
  reps       Int?
  restTime   Int? // en segundos

  routine  Routine  @relation(fields: [routineId], references: [id])
  exercise Exercise @relation(fields: [exerciseId], references: [id])
}

enum Role {
  admin
  user
}

enum Level {
  Beginner
  Intermediate
  Advanced
}

model DailyUserCount {
  id      Int      @id @default(autoincrement())
  date    DateTime
  basic   Int      @default(0)
  premium Int      @default(0)
  sedeId  Int      @default(1)
  sede    Sede     @relation(fields: [sedeId], references: [id])
}

model Sede {
  id             Int              @id @default(autoincrement())
  name           String
  address        String
  latitude       Float
  longitude      Float
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  classes        Class[]
  users          String[]         @default([])
  routines       Routine[]
  dailyUserCount DailyUserCount[]
  goals          Goal[]
  points         PointEvent[]
}

enum GoalCategory {
  USER_REGISTRATIONS
  CLASS_ENROLLMENTS
  ROUTINE_ASSIGNMENTS
}

model Goal {
  id              Int          @id @default(autoincrement())
  title           String
  description     String?
  category        GoalCategory
  targetValue     Int
  currentValue    Int          @default(0)
  startDate       DateTime     @default(now())
  endDate         DateTime
  sedeId          Int
  sede            Sede         @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  targetClassId   Int?
  targetClass     Class?       @relation(fields: [targetClassId], references: [id], onDelete: SetNull)
  targetRoutineId Int?
  targetRoutine   Routine?     @relation(fields: [targetRoutineId], references: [id], onDelete: SetNull)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model ApiKey {
  id        String    @id @default(uuid())
  userId    String    @unique
  keyHash   String    @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  lastUsed  DateTime?
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([keyHash])
}

enum PointEventType {
  CLASS_ENROLL
  ROUTINE_ASSIGN
  ROUTINE_COMPLETE
}

model PointEvent {
  id        Int            @id @default(autoincrement())
  userId    String
  sedeId    Int
  type      PointEventType
  points    Int
  classId   Int?
  routineId Int?
  createdAt DateTime       @default(now())

  sede Sede @relation(fields: [sedeId], references: [id])
}

model ExercisePerformance {
  id         Int      @id @default(autoincrement())
  userId     String
  routineId  Int?
  exerciseId Int
  weight     Float
  reps       Int
  createdAt  DateTime @default(now())

  routine  Routine? @relation(fields: [routineId], references: [id])
  exercise Exercise @relation(fields: [exerciseId], references: [id])

  @@index([userId, exerciseId])
  @@index([userId, routineId])
}

enum BadgeMetric {
  TOTAL_POINTS
  CLASS_ENROLL_COUNT
  ROUTINE_COMPLETE_COUNT
}

model Badge {
  id          Int         @id @default(autoincrement())
  code        String      @unique
  name        String
  description String?
  icon        String?     
  metric      BadgeMetric
  threshold   Int         

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  userBadges  UserBadge[]
}

model UserBadge {
  id        Int      @id @default(autoincrement())
  badgeId   Int
  userId    String   
  earnedAt  DateTime @default(now())

  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([badgeId, userId]) 
}
